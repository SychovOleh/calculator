"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),ENTER_KEYCODE=13,ESC_KEYCODE=27,Calc=function(){function e(){var t=this;_classCallCheck(this,e),this.calcStore={inputVal:"",prevInputVal:""},this.calcScreen=document.querySelector(".calc__screen"),this.calcBoard=document.querySelector(".calc__keyboard"),this.mapToParser=function(){return t.bracketParser(t.calcStore)},this.mapResultToView=function(e){return t.viewResult(e,t.calcScreen)},this.openBracketsCount,this.closeBracketsCount,this.replaceRegExp=/[^-\d\+\(\)\*\/]/g,this.fullStringVerificationRegExp=/^(\(*-?\d+\)*[-\+\*\/]{1}\(*-?)+$|^(\(*-?\d+\)*[-\+\*\/]{1}\(*-?)+$|^(\(*-?\d+\)*[-\+\*\/]{1}\(*-?)+\(*-?\d+\)*$|^\(*-?\d+\)*$|\(*\d*/,this.piecesOfStringRegExp=/[-\+\*\/][-\+\*\/]|-\)|^[-\+\*\/]|\d\(/,this.emptyBracketsRegExp=/\(\)/,this.oneNumInBracketsRegExp=/\(\_\d+\)/,this.avoidBracketsRegExp=/[^0-9_]/,this.operatorsPreorityCurve=[/[\*\/]/,/[\+\-]/],this.bracketOpenIndex,this.bracketCloseIndex,this.calcScreen.oninput=function(){return t.viewInputVerification()},this.calcScreen.addEventListener("paste",this.viewInputVerification.bind(this)),this.calcScreen.addEventListener("cut",this.viewInputVerification.bind(this)),this.calcBoard.addEventListener("click",this.keyboardToScreen.bind(this)),document.addEventListener("keydown",this.keyboardToScreen.bind(this))}return _createClass(e,[{key:"viewResult",value:function(e,t){t.value=e}},{key:"keyboardToScreen",value:function(e){var t="keydown"===e.type;if(t){if(e.keyCode!==ENTER_KEYCODE&&e.keyCode!==ESC_KEYCODE)return}else var r=e.target.textContent;if(t&&e.preventDefault(),"c"===r||e.keyCode===ESC_KEYCODE)return this.calcScreen.value="",void this.clearStoreFromView();"="!==r&&e.keyCode!==ENTER_KEYCODE?(this.calcScreen.value=this.calcScreen.value+r,this.viewInputVerification()):this.viewInputVerification(!0)}},{key:"viewInputVerification",value:function(e){var t=this.calcScreen;if(e)return this.prepareBeforeParse(t.value),void this.mapToParser();if(t.value=this.replaceExcessSymbols(t.value),!(t.value.length<1)){var r={result:!1};t.value=this.mainVerification(t.value,r),r.result||(t.value=this.piecesVerification(t.value))}}},{key:"clearStoreFromView",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.calcStore;for(var t in e)e[t]=""}},{key:"prepareBeforeParse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.emptyBracketsRegExp,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.oneNumInBracketsRegExp;e=e.replace(t,"");for(var i=this.openBracketsCount-this.closeBracketsCount,n=0;n<i;n+=1)e+=")";e=e.replace(/\(\-/g,"(_");for(var a=r.exec(e);null!==a;){var c=a.index,s=e.indexOf(")",c),o=e.substring(0,c),l=e.substring(c+1,s),u=e.substring(s+1,e.length);e=o+(l=l.replace(/[\(\)]/g,""))+u,a=r.exec(e)}this.calcStore.inputVal=e}},{key:"replaceExcessSymbols",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.replaceRegExp,r=e.replace(t,"");return r.length<1&&(this.calcStore.prevInputVal=""),r}},{key:"mainVerification",value:function(e,t){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.fullStringVerificationRegExp).test(e)?e:(t.result=!0,this.calcStore.prevInputVal)}},{key:"piecesVerification",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.piecesOfStringRegExp;return this.openBracketsCount=e.replace(/[^\(]/g,"").length,this.closeBracketsCount=e.replace(/[^\)]/g,"").length,this.closeBracketsCount>this.openBracketsCount||t.test(e)?this.calcStore.prevInputVal:(this.calcStore.prevInputVal=e,this.calcStore.inputVal=e,e)}},{key:"connectBracketExprToResult",value:function(e,t){var r=this.cutStringToArrayExpr(e),i=this.parseCalc(r),n=void 0;if(t)return n=i>0?i+"":"_"+Math.abs(i),void(this.calcStore.inputVal=this.replaceBracketExprToNum(this.calcStore.inputVal,e,n));this.mapResultToView(i)}},{key:"bracketParser",value:function(e){for(;;){var t=e.inputVal;if(this.bracketCloseIndex=t.indexOf(")"),-1===this.bracketCloseIndex)return void this.connectBracketExprToResult(t);this.bracketOpenIndex=t.lastIndexOf("(",this.bracketCloseIndex);var r=t.slice(this.bracketOpenIndex+1,this.bracketCloseIndex);this.connectBracketExprToResult(r,!0)}}},{key:"replaceBracketExprToNum",value:function(e,t,r){return e.replace("("+t+")",r)}},{key:"cutStringToArrayExpr",value:function(e){for(var t=[];;){var r=e.match(this.avoidBracketsRegExp);if(null===r)return t.push(parseInt(e.replace("_","-"),10)),t;var i=parseInt(e.substring(0,r.index).replace("_","-"),10),n=r[0];t.push(i,n),e=e.slice(r.index+1)}}},{key:"parseCalc",value:function(e){var t=this;return this.operatorsPreorityCurve.forEach(function(r){for(var i=0;i<e.length;i+=1)if(i%2!=0&&r.test(e[i])){var n=e[i],a=e[i-1],c=e[i+1],s=t.initMathExpr(a,n,c);e.splice(i-1,3,s),i-=1}}),e[0]}},{key:"initMathExpr",value:function(e,t,r){return"*"===t?e*r:"/"===t?e/r:"+"===t?e+r:"-"===t?e-r:void 0}}]),e}();new Calc;